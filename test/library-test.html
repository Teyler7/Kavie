<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Kavie Library Tests</title>

  <link rel="stylesheet" href="../node_modules/qunitjs/qunit/qunit.css">
  <script src="../node_modules/qunitjs/qunit/qunit.js"></script>


  <script src="../node_modules/knockout/build/output/knockout-latest.js"></script>
  <script src="../dist/kavie.js"></script>

  <script>

  Kavie.validatorFunctions.asyncBool = {
    async: true,
    validator: function(propVal, eleVal, callback) {
      setTimeout(function(){
        callback(propVal);
      }, 100);
    }
  }

  QUnit.test("Basic Functionality", function(assert) {
    Kavie.reset();

    var basicViewModel = {
      value: ko.observable().extend({ kavie: { required: true, minLength: 2 } })
    }

    assert.equal(Kavie.isValid(basicViewModel), false);

    basicViewModel.value("a"); // still doesnt work for minLength validator
    assert.equal(Kavie.isValid(basicViewModel), false);

    basicViewModel.value("abc"); // now it should be true
    assert.equal(Kavie.isValid(basicViewModel), true);
  });

  QUnit.test("Validator Methods Order", function(assert){
      Kavie.reset();
      var basicViewModel = {
        value: ko.observable().extend({
          kavie: {
            required: true,
            birthdate: true
          }
        })
      }

      assert.equal(Kavie.isValid(basicViewModel), false)

      basicViewModel = {
        value: ko.observable().extend({
          kavie: {
            birthdate: true,
            required: true,
          }
        })
      }

      assert.equal(Kavie.isValid(basicViewModel), false)
  })

  QUnit.test("Sections Basics", function(assert){
    Kavie.reset();

    var vm = {
      sectionValue: ko.observable().extend({
        kavie: {
          required: true,
          section: "section"
        }
      }),

      sectionValueTwo: ko.observable().extend({
        kavie: {
          required: true,
          section: "section"
        }
      }),

      otherValue: ko.observable().extend({
        kavie: { required: true }
      }),
    }

    assert.equal(Kavie.isSectionValid("section"), false);

    vm.sectionValue("er");
    vm.sectionValueTwo("er");

    assert.equal(Kavie.isSectionValid("section"), true);

    assert.equal(Kavie.isValid(vm), false);

    vm.otherValue(true);

    assert.equal(Kavie.isValid(vm), true);

  });

  QUnit.test("Variable Sections", function(assert){
    Kavie.reset();

    var vm = {
      sectionValue: ko.observable().extend({
        kavie: {
          required: true,
          section: "section"
        }
      }),
      validate: ko.observable(false)
    }

    Kavie.addVariableValidation("section", vm.validate);

    assert.equal(Kavie.isSectionValid("section"), true);

    vm.validate(true);

    assert.equal(Kavie.isSectionValid("section"), false);
  });

  QUnit.test("Children Sections", function(assert){
    Kavie.reset();

    var vm = {
      value: ko.observable().extend({
        kavie: {
          required: true,
          section: "parent"
        }
      }),
      valueTwo: ko.observable().extend({
        kavie: {
          required: true,
          section: "child"
        }
      })
    }

    Kavie.addSectionChild("parent", "child");

    assert.equal(Kavie.isSectionValid("parent"), false);
    vm.value("asdf");
    assert.equal(Kavie.isSectionValid("parent"), false);
    vm.valueTwo("asdf");
    assert.equal(Kavie.isSectionValid("parent"), true);

  });

  QUnit.test("Async Validation", function(assert){
    Kavie.reset();
    // simple true/false single async testing

    var vm = {
      value: ko.observable().extend({ kavie: { asyncBool: true } })
    }

    var done = assert.async();
    Kavie.isValidAsync(vm).then(function(isValid){
      assert.equal(isValid, true);
      done();
    });

    vm.value = ko.observable().extend({ kavie:{ asyncBool: false } })

    var done2 = assert.async();
    Kavie.isValidAsync(vm).then(function(isValid){
      assert.equal(isValid, false);
      done2();
    });

    // Multi Variable propVal and eleVal testing
    Kavie.validatorFunctions.asyncVals = {
      async: true,
      validator: function(propVal, eleVal, callback) {
        setTimeout(function(){
          callback(propVal === eleVal);
        }, 1000);
      }
    }

    vm.value = ko.observable().extend({ kavie: { asyncVals: '1' } })
    vm.valueTwo = ko.observable().extend({ kavie: { asyncVals: '2' } })

    var done3 = assert.async();
    Kavie.isValidAsync(vm).then(function(isValid){
      assert.equal(isValid, false);
      done3();
    });

    vm.value('1');
    var done4 = assert.async();
    Kavie.isValidAsync(vm).then(function(isValid){
      assert.equal(isValid, false);
      done4();
    });

    vm.value('1');
    vm.valueTwo('2');
    var done5 = assert.async();
    Kavie.isValidAsync(vm).then(function(isValid){
      assert.equal(isValid, true);
      done5();
    });

  })

  QUnit.test("Async Sections", function(assert){
    Kavie.reset();

    var vm = {
      valSecA: ko.observable().extend({ kavie: { asyncBool: true, section: "a" } }),
      valSecB: ko.observable().extend({ kavie: { asyncBool: false, section: "b"} })
    }

    var done = assert.async();
    Kavie.isSectionValidAsync("a").then(function(isValid){
      assert.equal(isValid, true);
      done();
    })

  })

  QUnit.test("Async Children", function(assert){
    Kavie.reset();

    var vm = {
      valSecA: ko.observable().extend({ kavie: { asyncBool: true, section: "parent" } }),
      valSecB: ko.observable().extend({ kavie: { asyncBool: false, section: "child"} })
    }

    Kavie.addSectionChild("parent", "child");

    var done = assert.async();
    Kavie.isSectionValidAsync("parent").then(function(isValid){
      assert.equal(isValid, false);
      done();
    })
  })
  </script>

</head>
<body>
    <div id="qunit"></div>
</body>
</html>
